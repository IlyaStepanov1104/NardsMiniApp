#!/bin/bash

# –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ PM2
APP_NAME="nards-app"

# –ü–∞–ø–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_DIR="/var/www/nards"  # –∑–∞–º–µ–Ω–∏ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –ø—É—Ç—å

echo "‚û° –ü–µ—Ä–µ—Ö–æ–∂—É –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞: $PROJECT_DIR"
cd "$PROJECT_DIR" || exit 1

echo "üîÑ –ü–æ–ª—É—á–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git..."
git pull origin main || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ git pull"; exit 1; }

echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
npm install || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ npm install"; exit 1; }

echo "üî® –ë–∏–ª–¥—é –ø—Ä–æ–µ–∫—Ç..."
npm run build || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ npm run build"; exit 1; }

echo "üßπ –£–¥–∞–ª—è—é —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –∏–∑ pm2 (–µ—Å–ª–∏ –µ—Å—Ç—å)..."
pm2 stop "$APP_NAME" > /dev/null 2>&1
pm2 delete "$APP_NAME" > /dev/null 2>&1

echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —á–µ—Ä–µ–∑ pm2..."
pm2 start ecosystem.config.js --name "$APP_NAME" || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ pm2"; exit 1; }

echo "üíæ –°–æ—Ö—Ä–∞–Ω—è—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é pm2 (–¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)..."
pm2 save

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –∫–∞–∫ $APP_NAME"
